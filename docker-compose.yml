services:
  mongo:
    image: mongo
    restart: always
    ports:
      - 27017:27017
    volumes:
      - mongo-data:/data/db
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro

  cturin:
    build: .
    container_name: cturin-app
    restart: always
    volumes:
      - ./data:/app/data
    environment:
      ProjectsDatabaseSettings__Host: mongo
      TasksDatabaseSettings__Host: mongo
      SensorTasksDatabaseSettings__Host: mongo
      CredentialsDatabaseSettings__Host: mongo
      ActivityMapsDatabaseSettings__Host: mongo
      LoginCredentialsDatabaseSettings__Host: mongo
      PinterestDatabaseSettings__Host: mongo
      CameraHubDatabaseSettings__Host: mongo
      VirtualMapLocationsDatabaseSettings__Host: mongo
      ActivityAndLocationHistoryDatabaseSettings__Host: mongo
      # JWT and Authentication
      JWT_SECRET: ${JWT_SECRET}
      PASSWORD_SALT: ${PASSWORD_SALT}
      # API Secrets
      CAMERA_HUB_SECRET: ${CAMERA_HUB_SECRET}
      CONNECTOR_SECRET: ${CONNECTOR_SECRET}
      # Email Configuration
      EMAIL_ADDRESS: ${EMAIL_ADDRESS}
      EMAIL_PASSWORD: ${EMAIL_PASSWORD}
      # Pinterest OAuth Configuration
      PINTEREST_ID: ${PINTEREST_ID}
      PINTEREST_SECRET: ${PINTEREST_SECRET}
      PINTEREST_REDIRECT_URI: ${PINTEREST_REDIRECT_URI}
      PINTEREST_SCOPE: ${PINTEREST_SCOPE}
      PINTEREST_API_URL: ${PINTEREST_API_URL}
      PINTEREST_PHOTOS_URL: ${PINTEREST_PHOTOS_URL}
      PINTEREST_ACCOUNT: ${PINTEREST_ACCOUNT}
      # Camunda Configuration
      CAMUNDA_BASE_URL: ${CAMUNDA_BASE_URL}
      # Application URLs
      PLATFORM_URL: ${PLATFORM_URL}
      BLOCKCHAIN_API_URL: ${BLOCKCHAIN_API_URL:-}
      PINTEREST_COVER_IMAGE_URL: ${PINTEREST_COVER_IMAGE_URL}
      # CORS Configuration
      CORS_ORIGINS: ${CORS_ORIGINS}
    depends_on:
      - mongo

  caddy:
    image: caddy:2.11-alpine
    container_name: cturin-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deployment/caddy/conf:/etc/caddy
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - caddy_net

  authentik-proxy:
    image: ghcr.io/goauthentik/proxy:2025.10.1
    container_name: authentik-proxy
    ports:
      - "9000:9000"
      - "9443:9443"
    environment:
      AUTHENTIK_HOST: ${AUTHENTIK_HOST}
      AUTHENTIK_INSECURE: "false"
      AUTHENTIK_TOKEN: ${AUTHENTIK_TOKEN}
    restart: unless-stopped
    networks:
      - caddy_net

volumes:
  mongo-data:
  caddy_data:
  caddy_config:

networks:
  caddy_net:
    external: true
